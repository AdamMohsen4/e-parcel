import{t as e,s as t}from"./index-Cd7cJI0f.js";import{aH as a,aI as i}from"./vendor-Do_qGNvM.js";const r=async t=>{try{await new Promise((e=>setTimeout(e,800)));const e=await(async e=>{const t=new a({orientation:"portrait",unit:"mm",format:"a6"});t.setFillColor(255,255,255),t.rect(0,0,t.internal.pageSize.width,t.internal.pageSize.height,"F"),t.setFontSize(16),t.setFont("helvetica","bold"),t.text(e.carrierName.toUpperCase(),10,10),t.setFontSize(12),t.setFont("helvetica","normal"),t.text("Batch: Batch-001-HEL",10,17),t.setFontSize(11),t.text(`Tracking: ${e.trackingCode}`,10,24),t.text(`Shipment ID: ${e.shipmentId}`,10,30),t.setFontSize(10),t.setFont("helvetica","bold"),t.text("FROM:",10,40),t.setFont("helvetica","normal"),t.text(e.senderAddress.split(",").slice(0,2).join(", "),10,45),t.setFont("helvetica","bold"),t.text("TO:",10,60),t.setFont("helvetica","normal"),t.text(e.recipientAddress.split(",").slice(0,2).join(", "),10,65),t.setFont("helvetica","bold"),t.text("PACKAGE:",10,80),t.setFont("helvetica","normal"),t.text(`Weight: ${e.packageDetails.weight}`,10,85),t.text(`Dimensions: ${e.packageDetails.dimensions}`,10,90);try{const a=await(async e=>{try{return await i.toDataURL(e,{errorCorrectionLevel:"M",margin:1,width:200})}catch(t){throw t}})(JSON.stringify({shipmentId:e.shipmentId,trackingCode:e.trackingCode,carrier:e.carrierName}));return t.addImage(a,"PNG",70,55,30,30),t.setFontSize(8),t.text("SCAN FOR TRACKING",75,90),t.output("blob")}catch(r){throw r}})(t);return{labelUrl:URL.createObjectURL(e),labelBlob:e,success:!0}}catch(r){return e({title:"Label Generation Failed",description:"Unable to generate shipping label. Please try again.",variant:"destructive"}),{labelUrl:"",success:!1,message:"Failed to generate label"}}},n=new Map,s=async(e,a,i,r,n,s)=>{try{const{data:o,error:c}=await t.from("booking").insert([{tracking_code:a,user_id:e.userId,status:"pending",pickup_address:"string"==typeof e.pickup?e.pickup:JSON.stringify(e.pickup),delivery_address:"string"==typeof e.delivery?e.delivery:JSON.stringify(e.delivery),weight:e.weight,dimension_length:e.dimensions.length,dimension_width:e.dimensions.width,dimension_height:e.dimensions.height,carrier_name:e.carrier.name||"E-Parcel Nordic",carrier_price:e.carrier.price,total_price:n,cancellation_deadline:s.toISOString(),can_be_cancelled:"yes",created_at:(new Date).toISOString(),customer_type:e.customerType||"private",pooling_enabled:e.poolingEnabled?"yes":"no",delivery_date:e.deliveryDate?new Date(e.deliveryDate).toISOString():null,payment_method:e.paymentMethod,payment_details:e.paymentDetails?JSON.stringify(e.paymentDetails):null,terms_accepted:e.termsAccepted?"yes":"no",label_url:i,pickup_time:r}]);return!c}catch(o){return!1}},o=async(e,a)=>{try{const i=`bookings-${e}-${a||"all"}`,r=n.get(i);if(r&&Date.now()-r.timestamp<3e5)return r.data;let s=t.from("booking").select("*").eq("user_id",e).order("created_at",{ascending:!1});a&&(s=s.limit(a));const{data:o,error:c}=await s;return c?[]:(n.set(i,{data:o||[],timestamp:Date.now()}),o||[])}catch(i){return[]}},c=async(e,a)=>{try{const{data:i,error:r}=await t.from("booking").select("*").eq("tracking_code",e).eq("user_id",a).maybeSingle();return r?null:i}catch(i){return null}};export{r as a,o as f,c as g,s};
