import{s as e,t}from"./index-59738moQ.js";import{aH as a,aI as i}from"./vendor-Do_qGNvM.js";const r=new Map,n=async(t,a,i,r,n,s,o)=>{try{const{data:c,error:l}=await e.from("booking").insert([{tracking_code:a,user_id:t.userId,status:"pending",pickup_address:"string"==typeof t.pickup?t.pickup:JSON.stringify(t.pickup),delivery_address:"string"==typeof t.delivery?t.delivery:JSON.stringify(t.delivery),weight:t.weight,dimension_length:t.dimensions.length,dimension_width:t.dimensions.width,dimension_height:t.dimensions.height,carrier_name:t.carrier.name||"E-Parcel Nordic",carrier_price:t.carrier.price,total_price:n,cancellation_deadline:o.toISOString(),can_be_cancelled:"yes",created_at:(new Date).toISOString(),customer_type:t.customerType||"private",pooling_enabled:t.poolingEnabled?"yes":"no",delivery_date:t.deliveryDate?new Date(t.deliveryDate).toISOString():null,payment_method:t.paymentMethod,payment_details:t.paymentDetails?JSON.stringify(t.paymentDetails):null,terms_accepted:t.termsAccepted?"yes":"no",label_url:i,pickup_time:r,estimated_delivery:s,delivery_speed:t.poolingEnabled?"economy":"express"}]);return!l}catch(c){return!1}},s=async(t,a)=>{try{const i=`bookings-${t}-${a||"all"}`,n=r.get(i);if(n&&Date.now()-n.timestamp<3e5)return n.data;let s=e.from("booking").select("*").eq("user_id",t).order("created_at",{ascending:!1});a&&(s=s.limit(a));const{data:o,error:c}=await s;return c?[]:(r.set(i,{data:o||[],timestamp:Date.now()}),o||[])}catch(i){return[]}},o=async(t,a)=>{try{const{data:i,error:r}=await e.from("booking").select("*").eq("tracking_code",t).eq("user_id",a).maybeSingle();return r?null:i}catch(i){return null}},c=async e=>{try{await new Promise((e=>setTimeout(e,800)));const t=await(async e=>{const t=new a({orientation:"portrait",unit:"mm",format:"a6"});t.setFillColor(255,255,255),t.rect(0,0,t.internal.pageSize.width,t.internal.pageSize.height,"F"),t.setFontSize(16),t.setFont("helvetica","bold"),t.text(e.carrierName.toUpperCase(),10,10),t.setFontSize(12),t.setFont("helvetica","normal"),t.text("Batch: Batch-001-HEL",10,17),t.setFontSize(11),t.text(`Tracking: ${e.trackingCode}`,10,24),t.text(`Shipment ID: ${e.shipmentId}`,10,30),t.setFontSize(10),t.setFont("helvetica","bold"),t.text("FROM:",10,40),t.setFont("helvetica","normal"),t.text(e.senderAddress.split(",").slice(0,2).join(", "),10,45),t.setFont("helvetica","bold"),t.text("TO:",10,60),t.setFont("helvetica","normal"),t.text(e.recipientAddress.split(",").slice(0,2).join(", "),10,65),t.setFont("helvetica","bold"),t.text("PACKAGE:",10,80),t.setFont("helvetica","normal"),t.text(`Weight: ${e.packageDetails.weight}`,10,85),t.text(`Dimensions: ${e.packageDetails.dimensions}`,10,90);try{const a=await(async e=>{try{return await i.toDataURL(e,{errorCorrectionLevel:"M",margin:1,width:200})}catch(t){throw t}})(JSON.stringify({shipmentId:e.shipmentId,trackingCode:e.trackingCode,carrier:e.carrierName}));return t.addImage(a,"PNG",70,55,30,30),t.setFontSize(8),t.text("SCAN FOR TRACKING",75,90),t.output("blob")}catch(r){throw r}})(e);return{labelUrl:URL.createObjectURL(t),labelBlob:t,success:!0}}catch(r){return t({title:"Label Generation Failed",description:"Unable to generate shipping label. Please try again.",variant:"destructive"}),{labelUrl:"",success:!1,message:"Failed to generate label"}}};export{c as a,s as f,o as g,n as s};
