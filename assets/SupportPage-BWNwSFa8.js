import{F as e,u as s,r as t,aN as r,j as a,aO as i,aH as o}from"./vendor-react-c2Vhr46D.js";import{aF as l,aG as c}from"./vendor-Do_qGNvM.js";import{N as n,L as d,I as p,B as u,C as m,s as h,t as x}from"./index-59738moQ.js";import{T as g,D as j,a as y,b as f,c as v,d as b,f as N}from"./textarea-BepzoKVg.js";import{S as w}from"./separator-BenccHGx.js";import{S,a as C,b as _,c as k,d as F}from"./select-C3qoNPeJ.js";import"./vendor-ui-CttiZxwU.js";const q=l.object({subject:l.string().min(5,"Subject must be at least 5 characters"),message:l.string().min(20,"Message must be at least 20 characters"),category:l.string(),priority:l.string()}),P=()=>{const{t:l}=e(),{user:P}=s(),[R,T]=t.useState([]),[$,I]=t.useState(!1),[M,V]=t.useState(!1),[A,D]=t.useState(null),[E,L]=t.useState(!1),[U,Y]=t.useState([]),[H,B]=t.useState(""),[O,G]=t.useState(!1),{control:z,register:J,handleSubmit:K,formState:{errors:Q},reset:W}=r({resolver:c(q),defaultValues:{subject:"",message:"",category:"general",priority:"medium"}}),X=async()=>{if(P)try{const{data:e,error:s}=await h.from("support_tickets").select("*").eq("user_id",P.id).order("created_at",{ascending:!1});if(s)throw s;T(e||[]),V(!0)}catch(e){x({title:"Error",description:"Failed to load support tickets",variant:"destructive"})}};t.useEffect((()=>{!P||M||$||(I(!0),X().finally((()=>I(!1))))}),[P,M]);const Z=async e=>{if(P)try{const{data:s,error:t}=await h.from("support_messages").select("*").eq("ticket_id",e).order("created_at",{ascending:!0});if(t)throw t;Y(s||[])}catch(s){x({title:"Error",description:"Failed to load message history",variant:"destructive"})}},ee=async e=>{D(e),L(!0),await Z(e.id)},se=e=>new Date(e).toLocaleString(),te=e=>{switch(e){case"open":return"bg-blue-100 text-blue-800";case"in_progress":return"bg-yellow-100 text-yellow-800";case"resolved":return"bg-green-100 text-green-800";default:return"bg-gray-100 text-gray-800"}};return a.jsxs("div",{className:"min-h-screen bg-background",children:[a.jsx(n,{}),a.jsxs("main",{className:"container mx-auto px-4 py-8",children:[a.jsx("h1",{className:"text-3xl font-bold mb-6",children:l("support.title","Customer Support")}),a.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[a.jsxs("div",{children:[a.jsx("h2",{className:"text-xl font-semibold mb-4",children:l("support.newRequest","Submit a Support Request")}),a.jsxs("form",{onSubmit:K((async e=>{if(P){I(!0);try{const s={user_id:P.id,subject:e.subject,message:e.message,category:e.category,priority:e.priority,status:"open"},{error:t}=await h.from("support_tickets").insert(s);if(t)throw t;x({title:"Success",description:"Your support request has been submitted"}),W(),X()}catch(s){x({title:"Error",description:"Failed to submit support request",variant:"destructive"})}finally{I(!1)}}})),className:"space-y-4",children:[a.jsxs("div",{children:[a.jsx(d,{htmlFor:"category",children:l("support.category","Category")}),a.jsx(i,{name:"category",control:z,render:({field:e})=>a.jsxs(S,{defaultValue:e.value,onValueChange:e.onChange,children:[a.jsx(C,{id:"category",children:a.jsx(_,{placeholder:l("support.selectCategory","Select category")})}),a.jsxs(k,{children:[a.jsx(F,{value:"general",children:l("support.categories.general","General Inquiry")}),a.jsx(F,{value:"shipping",children:l("support.categories.shipping","Shipping Issue")}),a.jsx(F,{value:"billing",children:l("support.categories.billing","Billing")}),a.jsx(F,{value:"technical",children:l("support.categories.technical","Technical Support")})]})]})})]}),a.jsxs("div",{children:[a.jsx(d,{htmlFor:"priority",children:l("support.priority","Priority")}),a.jsx(i,{name:"priority",control:z,render:({field:e})=>a.jsxs(S,{defaultValue:e.value,onValueChange:e.onChange,children:[a.jsx(C,{id:"priority",children:a.jsx(_,{placeholder:l("support.selectPriority","Select priority")})}),a.jsxs(k,{children:[a.jsx(F,{value:"low",children:l("support.priorities.low","Low")}),a.jsx(F,{value:"medium",children:l("support.priorities.medium","Medium")}),a.jsx(F,{value:"high",children:l("support.priorities.high","High")}),a.jsx(F,{value:"urgent",children:l("support.priorities.urgent","Urgent")})]})]})})]}),a.jsxs("div",{children:[a.jsx(d,{htmlFor:"subject",children:l("support.subject","Subject")}),a.jsx(p,{id:"subject",...J("subject"),placeholder:l("support.subjectPlaceholder","Brief description of your issue")}),Q.subject&&a.jsx("p",{className:"text-sm text-destructive mt-1",children:Q.subject.message})]}),a.jsxs("div",{children:[a.jsx(d,{htmlFor:"message",children:l("support.message","Message")}),a.jsx(g,{id:"message",...J("message"),rows:5,placeholder:l("support.messagePlaceholder","Please describe your issue in detail")}),Q.message&&a.jsx("p",{className:"text-sm text-destructive mt-1",children:Q.message.message})]}),a.jsx(u,{type:"submit",disabled:$,children:$?l("common.submitting","Submitting..."):l("support.submit","Submit Request")})]})]}),a.jsxs("div",{children:[a.jsx("h2",{className:"text-xl font-semibold mb-4",children:l("support.history","Your Support Tickets")}),$&&!M?a.jsx("p",{children:l("common.loading","Loading...")}):R.length>0?a.jsx("div",{className:"space-y-4",children:R.map((e=>a.jsxs(m,{className:"p-4 hover:shadow-md transition-shadow cursor-pointer",onClick:()=>ee(e),children:[a.jsxs("div",{className:"flex justify-between items-start",children:[a.jsxs("div",{children:[a.jsx("h3",{className:"font-medium",children:e.subject}),a.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:[l(`support.categories.${e.category}`,e.category)," â€¢ ",l(`support.priorities.${e.priority}`,e.priority)]})]}),a.jsx("div",{className:`px-2 py-1 rounded-full text-xs font-medium ${te(e.status)}`,children:l(`support.status.${e.status}`,"in_progress"===e.status?"In Progress":e.status.charAt(0).toUpperCase()+e.status.slice(1))})]}),a.jsx(w,{className:"my-3"}),a.jsx("p",{className:"text-sm line-clamp-3",children:e.message}),a.jsxs("div",{className:"flex justify-between items-center mt-3",children:[a.jsxs("p",{className:"text-xs text-muted-foreground",children:[l("support.created","Created"),": ",new Date(e.created_at).toLocaleString()]}),a.jsx(u,{variant:"outline",size:"sm",className:"text-xs",onClick:s=>{s.stopPropagation(),ee(e)},children:l("support.viewDetails","View Details")})]})]},e.id)))}):a.jsx("p",{className:"text-muted-foreground",children:l("support.noTickets","You have no support tickets yet.")})]})]})]}),a.jsx(j,{open:E,onOpenChange:L,children:a.jsx(y,{className:"sm:max-w-lg max-h-[90vh] overflow-y-auto",children:A&&a.jsxs(a.Fragment,{children:[a.jsxs(f,{children:[a.jsx(v,{children:A.subject}),a.jsxs(b,{className:"flex items-center justify-between pt-2",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("div",{className:`px-2 py-1 rounded-full text-xs font-medium ${te(A.status)}`,children:"in_progress"===A.status?"In Progress":A.status.charAt(0).toUpperCase()+A.status.slice(1)}),a.jsx("span",{className:"text-sm text-muted-foreground",children:l(`support.priorities.${A.priority}`,A.priority.charAt(0).toUpperCase()+A.priority.slice(1))})]}),a.jsx("span",{className:"text-xs text-muted-foreground",children:se(A.created_at)})]})]}),a.jsxs("div",{className:"mt-4 space-y-4",children:[a.jsxs("div",{children:[a.jsx("h4",{className:"text-sm font-medium",children:l("support.category","Category")}),a.jsx("p",{className:"text-sm mt-1",children:l(`support.categories.${A.category}`,A.category.charAt(0).toUpperCase()+A.category.slice(1))})]}),a.jsxs("div",{children:[a.jsx("h4",{className:"text-sm font-medium",children:l("support.originalMessage","Original Message")}),a.jsx("div",{className:"mt-1 p-3 bg-muted rounded-md text-sm",children:a.jsx("p",{className:"whitespace-pre-wrap",children:A.message})})]}),U.length>0&&a.jsxs("div",{children:[a.jsx("h4",{className:"text-sm font-medium",children:l("support.messageHistory","Message History")}),a.jsx("div",{className:"space-y-3 mt-2 max-h-[200px] overflow-y-auto",children:U.map((e=>a.jsxs("div",{className:"p-3 rounded-md text-sm "+(e.is_admin?"bg-primary/10 ml-8":"bg-muted mr-8"),children:[a.jsxs("div",{className:"flex justify-between mb-1",children:[a.jsx("span",{className:"font-semibold",children:e.is_admin?l("support.agent","Support Agent"):l("support.you","You")}),a.jsx("span",{className:"text-xs text-muted-foreground",children:se(e.created_at)})]}),a.jsx("p",{className:"whitespace-pre-wrap",children:e.message})]},e.id)))})]}),["open","in_progress"].includes(A.status)&&a.jsxs("div",{children:[a.jsx("h4",{className:"text-sm font-medium",children:l("support.replyToSupport","Reply to Support")}),a.jsxs("div",{className:"mt-1",children:[a.jsx(g,{value:H,onChange:e=>B(e.target.value),placeholder:l("support.replyPlaceholder","Type your reply here..."),rows:3}),a.jsx("div",{className:"flex justify-end mt-2",children:a.jsxs(u,{onClick:async()=>{if(H.trim()&&A&&P){G(!0);try{const e={ticket_id:A.id,user_id:P.id,message:H.trim(),is_admin:!1},{error:s}=await h.from("support_messages").insert(e);if(s)throw s;B(""),await Z(A.id),x({title:"Reply Sent",description:"Your message has been sent to support."})}catch(e){x({title:"Error",description:"Failed to send your reply",variant:"destructive"})}finally{G(!1)}}},disabled:!H.trim()||O,className:"flex items-center",children:[O?l("common.sending","Sending..."):l("support.sendReply","Send Reply"),a.jsx(o,{className:"ml-2 h-4 w-4"})]})})]})]}),["resolved","closed"].includes(A.status)&&a.jsx("div",{className:"p-3 bg-gray-100 rounded-md text-sm",children:a.jsx("p",{children:l("support.ticketClosed","This ticket is now closed. If you need further assistance, please submit a new request.")})}),a.jsx("div",{className:"flex justify-end pt-4",children:a.jsx(N,{asChild:!0,children:a.jsx(u,{variant:"outline",children:l("common.close","Close")})})})]})]})})})]})};export{P as default};
